#
# WeMadeIt production image
# - Go API (SQLite) on 127.0.0.1:8080
# - Nginx on :80 serving static Next export + proxying /api/* to the Go API
# - Supervisor manages both processes
#

FROM node:20-alpine AS web-build
WORKDIR /app/web
COPY web/package.json web/package-lock.json ./
RUN npm ci
COPY web/ ./
# Build-time env; at runtime we use same-origin (/api/...) behind nginx.
ENV NEXT_PUBLIC_API_URL=""
RUN npm run build

FROM golang:1.25-alpine AS api-build
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . ./
RUN CGO_ENABLED=0 go build -trimpath -ldflags="-s -w" -o /out/wemadeit-api ./cmd/server

FROM nginx:alpine
RUN apk add --no-cache ca-certificates supervisor tzdata

COPY nginx.conf /etc/nginx/conf.d/default.conf
COPY supervisord.conf /etc/supervisord.conf

COPY --from=web-build /app/web/out/ /usr/share/nginx/html/
COPY --from=api-build /out/wemadeit-api /usr/local/bin/wemadeit-api

RUN mkdir -p /data /config

EXPOSE 80
CMD ["supervisord", "-c", "/etc/supervisord.conf"]
