<div class="py-6">
  <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-2xl font-semibold text-gray-900">Sales Pipeline</h1>
        <p class="mt-1 text-sm text-gray-600">Drag and drop deals between stages</p>
      </div>
      <%= link_to new_crm_deal_path, class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700" do %>
        <svg class="-ml-1 mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        New Deal
      <% end %>
    </div>

    <!-- Pipeline Board -->
    <div class="overflow-x-auto" data-controller="pipeline">
      <div class="flex space-x-4 pb-4" style="min-width: fit-content;">
        <% @stages.each do |stage| %>
          <div class="w-72 flex-shrink-0" data-pipeline-target="stage" data-stage-id="<%= stage.id %>">
            <!-- Stage Header -->
            <div class="bg-white rounded-t-lg px-4 py-3 border-b-4" style="border-color: <%= stage.color %>;">
              <div class="flex justify-between items-center">
                <h3 class="font-medium text-gray-900"><%= stage.name %></h3>
                <span class="text-sm text-gray-500"><%= stage.deals.count %></span>
              </div>
              <% stage_value = stage.deals.sum(:value) %>
              <p class="text-xs text-gray-500 mt-1"><%= number_to_currency(stage_value, unit: "EUR ") %></p>
            </div>

            <!-- Deals List -->
            <div class="bg-gray-100 rounded-b-lg p-2 min-h-[400px]" data-deals-list>
              <% stage.deals.each do |deal| %>
                <div class="bg-white rounded-lg shadow p-3 mb-2 cursor-move hover:shadow-md transition-shadow"
                     draggable="true"
                     data-pipeline-target="deal"
                     data-deal-id="<%= deal.id %>">
                  <%= link_to crm_deal_path(deal), class: "block" do %>
                    <h4 class="font-medium text-gray-900 text-sm"><%= deal.title %></h4>
                    <p class="text-xs text-gray-500 mt-1"><%= deal.organization.name %></p>
                    <div class="flex justify-between items-center mt-2">
                      <span class="text-sm font-semibold text-gray-900"><%= number_to_currency(deal.value, unit: "EUR ") %></span>
                      <% if deal.assigned_to %>
                        <span class="inline-flex items-center justify-center h-6 w-6 rounded-full bg-blue-100 text-blue-600 text-xs font-medium">
                          <%= deal.assigned_to.name.split.map(&:first).join.upcase[0..1] %>
                        </span>
                      <% end %>
                    </div>
                    <% if deal.expected_close_date %>
                      <p class="text-xs text-gray-400 mt-2">
                        Close: <%= deal.expected_close_date.strftime("%b %d") %>
                      </p>
                    <% end %>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
