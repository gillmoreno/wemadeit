<%= form_with model: quotation, class: "space-y-6" do |form| %>
  <% if quotation.errors.any? %>
    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md">
      <ul class="list-disc list-inside">
        <% quotation.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- Basic Info -->
  <div class="bg-white shadow rounded-lg p-6 space-y-6">
    <h3 class="text-lg font-medium text-gray-900">Basic Information</h3>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <%= form.label :deal_id, "Deal", class: "block text-sm font-medium text-gray-700" %>
        <%= form.collection_select :deal_id, Deal.includes(:organization, :contact).order(created_at: :desc), :id, ->(d) { "#{d.title} (#{d.organization&.name})" }, { prompt: "Select deal" }, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500", required: true %>
        <p class="mt-1 text-xs text-gray-500">Organization and contact are taken from the deal</p>
      </div>

      <div>
        <%= form.label :valid_until, "Valid Until", class: "block text-sm font-medium text-gray-700" %>
        <%= form.date_field :valid_until, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
      </div>
    </div>

    <div>
      <%= form.label :subject, "Title / Subject", class: "block text-sm font-medium text-gray-700" %>
      <%= form.text_field :subject, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500", placeholder: "Quote for website development" %>
    </div>

    <div>
      <%= form.label :introduction, class: "block text-sm font-medium text-gray-700" %>
      <%= form.text_area :introduction, rows: 4, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500", placeholder: "Thank you for your interest in our services..." %>
    </div>
  </div>

  <!-- Line Items -->
  <div class="bg-white shadow rounded-lg p-6" data-controller="nested-form">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-medium text-gray-900">Line Items</h3>
      <button type="button" data-action="nested-form#add" class="inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200">
        <svg class="-ml-0.5 mr-1.5 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Add Item
      </button>
    </div>

    <div data-nested-form-target="container" class="space-y-4">
      <% if quotation.quotation_items.any? %>
        <% quotation.quotation_items.each do |item| %>
          <%= form.fields_for :quotation_items, item do |item_form| %>
            <%= render "quotations/quotation_item_fields", form: item_form %>
          <% end %>
        <% end %>
      <% end %>
    </div>

    <!-- Template for new items -->
    <template data-nested-form-target="template">
      <%= form.fields_for :quotation_items, QuotationItem.new, child_index: "NEW_RECORD" do |item_form| %>
        <%= render "quotations/quotation_item_fields", form: item_form %>
      <% end %>
    </template>
  </div>

  <!-- Pricing -->
  <div class="bg-white shadow rounded-lg p-6 space-y-6">
    <h3 class="text-lg font-medium text-gray-900">Pricing</h3>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div>
        <%= form.label :tax_rate, "VAT Rate (%)", class: "block text-sm font-medium text-gray-700" %>
        <%= form.number_field :tax_rate, step: 0.01, min: 0, max: 100, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
      </div>

      <div>
        <%= form.label :discount_amount, "Discount Amount", class: "block text-sm font-medium text-gray-700" %>
        <%= form.number_field :discount_amount, step: 0.01, min: 0, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
      </div>

      <div>
        <%= form.label :currency, "Currency", class: "block text-sm font-medium text-gray-700" %>
        <%= form.select :currency, [["Euro (EUR)", "EUR"], ["US Dollar (USD)", "USD"], ["British Pound (GBP)", "GBP"]], {}, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
      </div>
    </div>
  </div>

  <!-- Terms & Conditions -->
  <div class="bg-white shadow rounded-lg p-6 space-y-6">
    <h3 class="text-lg font-medium text-gray-900">Terms & Conditions</h3>

    <div>
      <%= form.text_area :terms, rows: 6, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500", placeholder: "Payment terms, delivery conditions, etc." %>
    </div>
  </div>

  <!-- Submit -->
  <div class="flex justify-end space-x-3">
    <%= link_to "Cancel", quotations_path, class: "px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50" %>
    <%= form.submit quotation.persisted? ? "Update Quotation" : "Create Quotation", class: "px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 cursor-pointer" %>
  </div>
<% end %>
