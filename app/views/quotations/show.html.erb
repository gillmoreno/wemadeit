<div class="py-6">
  <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="flex justify-between items-start mb-6">
      <div>
        <div class="flex items-center space-x-3">
          <%= link_to quotations_path, class: "text-gray-400 hover:text-gray-500" do %>
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
          <% end %>
          <h1 class="text-2xl font-semibold text-gray-900"><%= @quotation.number %></h1>
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
            <%= case @quotation.status
                when 'draft' then 'bg-gray-100 text-gray-800'
                when 'sent' then 'bg-blue-100 text-blue-800'
                when 'viewed' then 'bg-yellow-100 text-yellow-800'
                when 'accepted' then 'bg-green-100 text-green-800'
                when 'declined' then 'bg-red-100 text-red-800'
                when 'expired' then 'bg-gray-100 text-gray-500'
                end %>">
            <%= @quotation.status.humanize %>
          </span>
          <% if @quotation.signed? %>
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-50 text-green-700">
              <svg class="mr-1 h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
              </svg>
              Signed
            </span>
          <% end %>
        </div>
        <p class="mt-1 text-lg text-gray-600"><%= @quotation.title %></p>
      </div>
      <div class="flex space-x-2">
        <%= link_to "Edit", edit_quotation_path(@quotation), class: "px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50" %>
        <%= link_to "PDF", preview_quotation_path(@quotation, format: :pdf), class: "px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50", target: "_blank" %>
        <% if @quotation.draft? %>
          <%= button_to "Send to Client", send_to_client_quotation_path(@quotation), method: :post, class: "px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700" %>
        <% end %>
        <%= button_to "Duplicate", duplicate_quotation_path(@quotation), method: :post, class: "px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50" %>
        <% if @quotation.accepted? %>
          <%= button_to "Convert to Project", convert_to_project_quotation_path(@quotation), method: :post, class: "px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700" %>
        <% end %>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Main Content -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Introduction -->
        <% if @quotation.introduction.present? %>
          <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Introduction</h2>
            <div class="prose prose-sm max-w-none text-gray-700">
              <%= simple_format(@quotation.introduction) %>
            </div>
          </div>
        <% end %>

        <!-- Line Items -->
        <div class="bg-white shadow rounded-lg overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900">Line Items</h2>
          </div>
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Price</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <% @items.each do |item| %>
                <tr>
                  <td class="px-6 py-4">
                    <div class="text-sm font-medium text-gray-900"><%= item.name %></div>
                    <% if item.description.present? %>
                      <div class="text-sm text-gray-500"><%= item.description %></div>
                    <% end %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                    <%= item.quantity %><% if item.unit_type.present? %> <span class="text-gray-500"><%= item.unit_type %></span><% end %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                    <%= number_to_currency(item.unit_price || 0, unit: @quotation.currency == "EUR" ? "€" : "$") %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 text-right">
                    <%= number_to_currency(item.line_total || 0, unit: @quotation.currency == "EUR" ? "€" : "$") %>
                  </td>
                </tr>
              <% end %>
            </tbody>
            <tfoot class="bg-gray-50">
              <tr>
                <td colspan="3" class="px-6 py-3 text-right text-sm font-medium text-gray-500">Subtotal</td>
                <td class="px-6 py-3 text-right text-sm font-medium text-gray-900">
                  <%= number_to_currency(@quotation.subtotal || 0, unit: @quotation.currency == "EUR" ? "€" : "$") %>
                </td>
              </tr>
              <% if @quotation.discount_amount && @quotation.discount_amount > 0 %>
                <tr>
                  <td colspan="3" class="px-6 py-3 text-right text-sm font-medium text-gray-500">Discount</td>
                  <td class="px-6 py-3 text-right text-sm font-medium text-red-600">
                    -<%= number_to_currency(@quotation.discount_amount, unit: @quotation.currency == "EUR" ? "€" : "$") %>
                  </td>
                </tr>
              <% end %>
              <% if @quotation.tax_rate && @quotation.tax_rate > 0 %>
                <tr>
                  <td colspan="3" class="px-6 py-3 text-right text-sm font-medium text-gray-500">VAT (<%= @quotation.tax_rate %>%)</td>
                  <td class="px-6 py-3 text-right text-sm font-medium text-gray-900">
                    <%= number_to_currency(@quotation.tax_amount || 0, unit: @quotation.currency == "EUR" ? "€" : "$") %>
                  </td>
                </tr>
              <% end %>
              <tr class="border-t-2 border-gray-300">
                <td colspan="3" class="px-6 py-4 text-right text-base font-semibold text-gray-900">Total</td>
                <td class="px-6 py-4 text-right text-lg font-bold text-gray-900">
                  <%= number_to_currency(@quotation.total || 0, unit: @quotation.currency == "EUR" ? "€" : "$") %>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- Terms & Conditions -->
        <% if @quotation.terms_and_conditions.present? %>
          <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Terms & Conditions</h2>
            <div class="prose prose-sm max-w-none text-gray-700">
              <%= simple_format(@quotation.terms_and_conditions) %>
            </div>
          </div>
        <% end %>

        <!-- Signature (if signed) -->
        <% if @quotation.signed? %>
          <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Signature</h2>
            <div class="space-y-3">
              <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                <% if @quotation.signature.signature_data.present? %>
                  <img src="<%= @quotation.signature.signature_data %>" alt="Signature" class="max-h-24">
                <% end %>
              </div>
              <div class="text-sm text-gray-600">
                <p><strong>Signed by:</strong> <%= @quotation.signature.signer_name %></p>
                <p><strong>Email:</strong> <%= @quotation.signature.signer_email %></p>
                <p><strong>Date:</strong> <%= @quotation.signature.signed_at&.strftime("%B %d, %Y at %H:%M") %></p>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- Client Info -->
        <div class="bg-white shadow rounded-lg p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4">Client</h3>
          <dl class="space-y-4">
            <div>
              <dt class="text-sm font-medium text-gray-500">Organization</dt>
              <dd class="mt-1">
                <%= link_to @quotation.organization.name, crm_organization_path(@quotation.organization), class: "text-sm text-blue-600 hover:text-blue-800" %>
              </dd>
            </div>
            <% if @quotation.contact %>
              <div>
                <dt class="text-sm font-medium text-gray-500">Contact</dt>
                <dd class="mt-1">
                  <%= link_to @quotation.contact.full_name, crm_contact_path(@quotation.contact), class: "text-sm text-blue-600 hover:text-blue-800" %>
                  <% if @quotation.contact.email.present? %>
                    <p class="text-xs text-gray-500"><%= @quotation.contact.email %></p>
                  <% end %>
                </dd>
              </div>
            <% end %>
            <% if @quotation.deal %>
              <div>
                <dt class="text-sm font-medium text-gray-500">Deal</dt>
                <dd class="mt-1">
                  <%= link_to @quotation.deal.title, crm_deal_path(@quotation.deal), class: "text-sm text-blue-600 hover:text-blue-800" %>
                </dd>
              </div>
            <% end %>
          </dl>
        </div>

        <!-- Quote Details -->
        <div class="bg-white shadow rounded-lg p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4">Details</h3>
          <dl class="space-y-4">
            <div>
              <dt class="text-sm font-medium text-gray-500">Created by</dt>
              <dd class="mt-1 text-sm text-gray-900"><%= @quotation.created_by&.name || "Unknown" %></dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Created</dt>
              <dd class="mt-1 text-sm text-gray-900"><%= @quotation.created_at.strftime("%B %d, %Y") %></dd>
            </div>
            <% if @quotation.valid_until %>
              <div>
                <dt class="text-sm font-medium text-gray-500">Valid Until</dt>
                <dd class="mt-1 text-sm <%= @quotation.expired? ? 'text-red-600' : 'text-gray-900' %>">
                  <%= @quotation.valid_until.strftime("%B %d, %Y") %>
                  <% if @quotation.expired? %>
                    <span class="text-xs text-red-500">(Expired)</span>
                  <% end %>
                </dd>
              </div>
            <% end %>
            <% if @quotation.version && @quotation.version > 1 %>
              <div>
                <dt class="text-sm font-medium text-gray-500">Version</dt>
                <dd class="mt-1 text-sm text-gray-900">v<%= @quotation.version %></dd>
              </div>
            <% end %>
          </dl>
        </div>

        <!-- Public Link -->
        <div class="bg-white shadow rounded-lg p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4">Share</h3>
          <p class="text-sm text-gray-500 mb-3">Share this link with the client to view and sign the quotation:</p>
          <div class="flex">
            <input type="text" readonly value="<%= public_quotation_url(@quotation.public_token) %>" class="flex-1 block w-full rounded-l-md border-gray-300 text-sm bg-gray-50">
            <button type="button" onclick="navigator.clipboard.writeText('<%= public_quotation_url(@quotation.public_token) %>')" class="px-3 py-2 border border-l-0 border-gray-300 rounded-r-md bg-gray-50 hover:bg-gray-100 text-sm text-gray-600">
              Copy
            </button>
          </div>
        </div>

        <!-- Actions -->
        <div class="bg-white shadow rounded-lg p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4">Actions</h3>
          <div class="space-y-2">
            <%= button_to "Delete Quotation", quotation_path(@quotation), method: :delete, data: { turbo_confirm: "Are you sure you want to delete this quotation?" }, class: "w-full px-4 py-2 border border-red-300 rounded-md text-sm font-medium text-red-700 hover:bg-red-50" %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
