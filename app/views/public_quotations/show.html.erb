<div class="max-w-4xl mx-auto px-4">
  <!-- Status Banner -->
  <% if @quotation.accepted? %>
    <div class="bg-green-100 border border-green-300 rounded-lg p-4 mb-6 flex items-center">
      <svg class="h-5 w-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
      <span class="text-green-800">This quotation has been accepted on <%= @quotation.signature.signed_at.strftime("%B %d, %Y") %></span>
    </div>
  <% elsif @quotation.declined? %>
    <div class="bg-red-100 border border-red-300 rounded-lg p-4 mb-6">
      <span class="text-red-800">This quotation has been declined.</span>
    </div>
  <% elsif @quotation.expired? %>
    <div class="bg-yellow-100 border border-yellow-300 rounded-lg p-4 mb-6">
      <span class="text-yellow-800">This quotation has expired.</span>
    </div>
  <% end %>

  <!-- Quotation Card -->
  <div class="bg-white shadow-lg rounded-lg overflow-hidden">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-8 text-white">
      <div class="flex justify-between items-start">
        <div>
          <h1 class="text-2xl font-bold">Quotation</h1>
          <p class="text-blue-100 mt-1"><%= @quotation.number %></p>
        </div>
        <div class="text-right">
          <p class="text-sm text-blue-100">Valid until</p>
          <p class="font-semibold"><%= @quotation.valid_until&.strftime("%B %d, %Y") || "N/A" %></p>
        </div>
      </div>
    </div>

    <!-- Client Info -->
    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
      <div class="grid grid-cols-2 gap-4">
        <div>
          <p class="text-sm text-gray-500">Prepared for</p>
          <p class="font-medium text-gray-900"><%= @quotation.organization.name %></p>
          <% if @quotation.contact %>
            <p class="text-sm text-gray-600"><%= @quotation.contact.full_name %></p>
          <% end %>
        </div>
        <div class="text-right">
          <p class="text-sm text-gray-500">Date</p>
          <p class="font-medium text-gray-900"><%= @quotation.created_at.strftime("%B %d, %Y") %></p>
        </div>
      </div>
    </div>

    <!-- Subject & Introduction -->
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900"><%= @quotation.subject %></h2>
      <% if @quotation.introduction.present? %>
        <p class="mt-2 text-gray-600"><%= @quotation.introduction %></p>
      <% end %>
    </div>

    <!-- Line Items -->
    <div class="px-6 py-4">
      <table class="w-full">
        <thead>
          <tr class="border-b border-gray-200">
            <th class="text-left py-2 text-sm font-medium text-gray-500">Description</th>
            <th class="text-center py-2 text-sm font-medium text-gray-500 w-20">Qty</th>
            <th class="text-right py-2 text-sm font-medium text-gray-500 w-28">Price</th>
            <th class="text-right py-2 text-sm font-medium text-gray-500 w-28">Total</th>
          </tr>
        </thead>
        <tbody>
          <% @quotation.quotation_items.order(:position).each do |item| %>
            <tr class="border-b border-gray-100">
              <td class="py-3">
                <p class="font-medium text-gray-900"><%= item.description.presence || item.service&.name %></p>
                <% if item.service&.description.present? %>
                  <p class="text-sm text-gray-500"><%= item.service.description %></p>
                <% end %>
              </td>
              <td class="py-3 text-center text-gray-600"><%= item.quantity %></td>
              <td class="py-3 text-right text-gray-600"><%= number_to_currency(item.unit_price, unit: "EUR ") %></td>
              <td class="py-3 text-right font-medium text-gray-900"><%= number_to_currency(item.line_total, unit: "EUR ") %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <!-- Totals -->
    <div class="px-6 py-4 bg-gray-50">
      <div class="flex justify-end">
        <div class="w-64">
          <div class="flex justify-between py-1">
            <span class="text-gray-600">Subtotal</span>
            <span class="text-gray-900"><%= number_to_currency(@quotation.subtotal, unit: "EUR ") %></span>
          </div>
          <% if @quotation.total_discount > 0 %>
            <div class="flex justify-between py-1">
              <span class="text-gray-600">Discount</span>
              <span class="text-green-600">-<%= number_to_currency(@quotation.total_discount, unit: "EUR ") %></span>
            </div>
          <% end %>
          <% if @quotation.tax_rate && @quotation.tax_rate > 0 %>
            <div class="flex justify-between py-1">
              <span class="text-gray-600">VAT (<%= @quotation.tax_rate %>%)</span>
              <span class="text-gray-900"><%= number_to_currency(@quotation.tax_amount, unit: "EUR ") %></span>
            </div>
          <% end %>
          <div class="flex justify-between py-2 border-t border-gray-300 mt-2">
            <span class="font-semibold text-gray-900">Total</span>
            <span class="font-bold text-xl text-gray-900"><%= number_to_currency(@quotation.total, unit: "EUR ") %></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Terms -->
    <% if @quotation.terms.present? %>
      <div class="px-6 py-4 border-t border-gray-200">
        <h3 class="text-sm font-medium text-gray-500 mb-2">Terms & Conditions</h3>
        <p class="text-sm text-gray-600 whitespace-pre-line"><%= @quotation.terms %></p>
      </div>
    <% end %>

    <!-- Signature Section -->
    <% if @quotation.accepted? && @quotation.signature %>
      <div class="px-6 py-4 border-t border-gray-200 bg-green-50">
        <h3 class="text-sm font-medium text-gray-500 mb-2">Accepted by</h3>
        <div class="flex items-center">
          <% if @quotation.signature.signature_type == "drawn" && @quotation.signature.signature_data.present? %>
            <img src="<%= @quotation.signature.signature_data %>" alt="Signature" class="h-16 mr-4">
          <% else %>
            <span class="text-2xl italic text-gray-700 mr-4" style="font-family: 'Brush Script MT', cursive;"><%= @quotation.signature.signer_name %></span>
          <% end %>
          <div>
            <p class="font-medium text-gray-900"><%= @quotation.signature.signer_name %></p>
            <p class="text-sm text-gray-500"><%= @quotation.signature.signer_email %></p>
            <p class="text-sm text-gray-500">Signed on <%= @quotation.signature.signed_at.strftime("%B %d, %Y at %I:%M %p") %></p>
          </div>
        </div>
      </div>
    <% elsif @quotation.can_be_signed? %>
      <!-- Accept Form -->
      <div class="px-6 py-6 border-t border-gray-200 bg-blue-50" id="accept-section">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Accept this Quotation</h3>

        <%= form_with url: accept_public_quotation_path(token: @quotation.public_token), method: :post, local: true, class: "space-y-4" do |form| %>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <%= form.label :signer_name, "Your Name", class: "block text-sm font-medium text-gray-700" %>
              <%= form.text_field :signer_name, name: "signature[signer_name]", required: true, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
            </div>
            <div>
              <%= form.label :signer_email, "Your Email", class: "block text-sm font-medium text-gray-700" %>
              <%= form.email_field :signer_email, name: "signature[signer_email]", required: true, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
            </div>
          </div>

          <!-- Signature Pad -->
          <div data-controller="signature-pad">
            <p class="block text-sm font-medium text-gray-700 mb-2">Your Signature</p>

            <!-- Tabs -->
            <div class="border-b border-gray-200 mb-4">
              <nav class="-mb-px flex space-x-8">
                <button type="button" data-signature-pad-target="tabDraw" data-action="click->signature-pad#switchToDrawMode" class="border-blue-500 text-blue-600 whitespace-nowrap pb-2 px-1 border-b-2 font-medium text-sm">
                  Draw
                </button>
                <button type="button" data-signature-pad-target="tabType" data-action="click->signature-pad#switchToTypeMode" class="border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap pb-2 px-1 border-b-2 font-medium text-sm">
                  Type
                </button>
              </nav>
            </div>

            <!-- Draw Mode -->
            <div>
              <div class="border-2 border-dashed border-gray-300 rounded-lg bg-white">
                <canvas data-signature-pad-target="canvas" class="w-full h-32 cursor-crosshair"></canvas>
              </div>
              <button type="button" data-action="click->signature-pad#clear" class="mt-2 text-sm text-gray-500 hover:text-gray-700">
                Clear signature
              </button>
            </div>

            <!-- Type Mode (hidden by default) -->
            <div class="hidden">
              <input type="text" data-signature-pad-target="typeInput" data-action="input->signature-pad#typeSignature" placeholder="Type your name" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
              <div class="mt-2 p-4 bg-white border border-gray-200 rounded-lg min-h-[80px] flex items-center justify-center">
                <span data-signature-pad-target="typedSignature" class="text-3xl italic text-gray-700" style="font-family: 'Brush Script MT', cursive;"></span>
              </div>
            </div>

            <%= form.hidden_field :signature_data, name: "signature[signature_data]", data: { signature_pad_target: "input" } %>
            <%= form.hidden_field :signature_type, name: "signature[signature_type]", value: "drawn" %>
          </div>

          <div class="flex items-center justify-between pt-4">
            <p class="text-sm text-gray-500">
              By clicking "Accept", you agree to the terms and conditions above.
            </p>
            <%= form.submit "Accept Quotation", class: "inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 cursor-pointer" %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Download PDF -->
  <div class="mt-6 text-center">
    <%= link_to "Download PDF", preview_quotation_path(@quotation, format: :pdf), class: "text-blue-600 hover:text-blue-800 text-sm" %>
  </div>
</div>
